# -*- coding:utf-8 -*-

from __future__ import unicode_literals

from curses.ascii import NL
import datetime
import logging

from time import time

import sys
from importlib import reload

import math
from django.contrib.auth.models import User
from django.db import models
from django.db.models.aggregates import Max
from django.db.models.fields import CharField, DecimalField, IntegerField, BigIntegerField, \
    BooleanField, TextField, DateTimeField, DateField, URLField
from django.db.models.fields.files import ImageField, FileField
from django.db.models.fields.related import ForeignKey, \
    OneToOneField
from imagekit.models.fields import ImageSpecField
from pilkit.processors.resize import ResizeToFill

import uuid

from radarlivre_api.utils import Math

logger = logging.getLogger("radarlivre.log")

reload(sys)
#sys.setdefaultencoding("utf-8")

class Collector(models.Model):

    key = models.UUIDField(default=uuid.uuid4, unique=True)
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name="collectors", null=True)
    
    latitude  = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    longitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    timestamp = BigIntegerField(default=0)
    timestampData = BigIntegerField(default=0)
    
    def getDate(self):
        return datetime.datetime.fromtimestamp(
            int(self.timestamp/1000)
        ).strftime('%d/%m/%Y %H:%M:%S')

    def getStrLatitude(self):
        return "%.8f" % self.latitude

    def getStrLongitude(self):
        return "%.8f" % self.longitude
    
    def __unicode__(self):
        return "Active collector from " + self.user.username

class Airline(models.Model):

    name = CharField(max_length=255, blank=True, null=True, default="")
    alias = CharField(max_length=255, blank=True, null=True, default="")
    iata = CharField(max_length=4, blank=True, null=True, default="")
    icao = CharField(max_length=8, blank=True, null=True, default="")
    callsign = CharField(max_length=255, blank=True, null=True, default="")
    country = CharField(max_length=255, blank=True, null=True, default="")
    active = BooleanField(default=True)


class Flight(models.Model):
    # Flight identification
    code = CharField(max_length=16, blank=True, null=True, default=True)
    airline = ForeignKey(Airline, on_delete = models.PROTECT, null=True, related_name="flights")

    def __unicode__(self):
        return "Flight " + str(self.code)



    
class Airport(models.Model):
    
    # Airport identification
    code = CharField(max_length=100, blank=True, default='', null=True)
    name = CharField(max_length=100, blank=True, default='', null=True)
    
    # Airport location
    country   = CharField(max_length=100, blank=True, default='', null=True)
    state     = CharField(max_length=100, blank=True, default='', null=True)
    city      = CharField(max_length=100, blank=True, default='', null=True)
    latitude  = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    longitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    type = CharField(max_length=100, blank=True, default='', null=True)
    
    def __unicode__(self):
        return "Airport " + self.prefix + " - " + self.name


class ADSBInfo(models.Model):

    collectorKey = models.CharField(max_length=64, blank=True, null=True, default="")

    modeSCode = CharField(max_length=16, blank=True, null=True, default="")
    callsign = CharField(max_length=16, blank=True, null=True, default="")

    # Airplane position
    latitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    longitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    altitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Airplane velocity
    verticalVelocity = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    horizontalVelocity = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Airplane angle
    groundTrackHeading = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Observation date time generated by server
    timestamp = BigIntegerField(default=0)
    timestampSent = BigIntegerField(default=0)

    # Originals ADS-B messages
    messageDataId = CharField(max_length=100, blank=True, default='')
    messageDataPositionEven = CharField(max_length=100, blank=True, default='')
    messageDataPositionOdd = CharField(max_length=100, blank=True, default='')
    messageDataVelocity = CharField(max_length=100, blank=True, default='')


class Observation(models.Model):

    flight = flight = ForeignKey(Flight, on_delete = models.PROTECT, null=True, blank=True, default=None, related_name='observations')
    adsbInfo = OneToOneField(ADSBInfo, on_delete = models.PROTECT, related_name="observation", null=True)

    # Airplane position
    latitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    longitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    altitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Airplane velocity
    verticalVelocity = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    horizontalVelocity = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Airplane angle
    groundTrackHeading = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Observation date time generated by server
    timestamp = BigIntegerField(default=0)

    simulated = BooleanField(default=False)

    def __unicode__(self):
        return "Observation of flight " + str(self.flight.code)

    @staticmethod
    def generateFromADSBInfo(info):
        # If the flight no exists, will be created

        collector = None
        try:
            collector = Collector.objects.get(key=info.collectorKey)
        except Exception as err:
            print (err)
            print (info.collectorKey)
            return None

        callsign = info.callsign
        airlineICAO = callsign[:3]
        airline = None
        flight = None
        try:
            airline = Airline.objects.get(icao=airlineICAO)
        except:
            pass

        try:
            flight = Flight.objects.get(code=callsign)
        except Flight.DoesNotExist:
            flight = Flight(code=callsign, airline=airline)
            flight.save()

        delay = info.timestampSent - info.timestamp
        timestamp = int(time() * 1000) - delay

        # Set a correct longitude
        if info.longitude > 180:
            info.longitude -= 360
        info.save()

        collector.timestampData = timestamp
        collector.save()

        obs = Observation(
            flight=flight,
            adsbInfo=info,
            timestamp=timestamp,
            latitude=info.latitude, longitude=info.longitude, altitude=info.altitude,
            verticalVelocity=info.verticalVelocity, horizontalVelocity=info.horizontalVelocity,
            groundTrackHeading=info.groundTrackHeading
        )
        obs.save()
        return obs


class FlightInfo(models.Model):
    # Flight identification
    flight = OneToOneField(Flight, on_delete = models.PROTECT, null=True)
    airline = ForeignKey(Airline, on_delete = models.PROTECT, null=True)

    # Airplane position
    latitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    longitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    altitude = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Airplane velocity
    verticalVelocity = DecimalField(max_digits=20, decimal_places=10, default=0.0)
    horizontalVelocity = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Airplane angle
    groundTrackHeading = DecimalField(max_digits=20, decimal_places=10, default=0.0)

    # Observation date time generated by server
    timestamp = BigIntegerField(default=0)

    @staticmethod
    def generateFromFlight(flight, obs):
        info = None
        try:
            info = FlightInfo.objects.get(flight=flight)
            info.latitude = obs.latitude
            info.longitude = obs.longitude
            info.altitude = obs.altitude
            info.verticalVelocity = obs.verticalVelocity
            info.horizontalVelocity = obs.horizontalVelocity
            info.groundTrackHeading = obs.groundTrackHeading
            info.timestamp=obs.timestamp
        except FlightInfo.DoesNotExist:
            info = FlightInfo(
                flight=flight, airline=flight.airline,
                latitude=obs.latitude,
                longitude=obs.longitude,
                altitude=obs.altitude,
                verticalVelocity=obs.verticalVelocity,
                horizontalVelocity=obs.horizontalVelocity,
                groundTrackHeading=obs.groundTrackHeading,
                timestamp=obs.timestamp
            )

        info.save()

    def generatePropagatedTrajectory(self, propCount, propInterval):


        observations = Observation.objects.filter(flight=self.flight).filter(simulated=True)
        for o in observations:
            o.delete()

        observations = Observation.objects.filter(flight=self.flight).order_by("-timestamp")[0:2]
        obs = []
        for o in observations:
            obs.append(o)
        obs.reverse()
        propInterval /= 1000.0

        for i in range(0, int(propCount)):
            infoA = obs[len(obs) - 2]
            infoB = obs[len(obs) - 1]

            turnRateInterval = (float(infoB.timestamp) - float(infoA.timestamp))/1000.0
            turnRate = 0 if turnRateInterval == 0 \
                else propInterval * (float(infoB.groundTrackHeading) - float(infoA.groundTrackHeading))/turnRateInterval
            groundTrackHeading = float(infoB.groundTrackHeading) + turnRate
            distance = Math.knotsToMetres(float(infoB.horizontalVelocity)) * propInterval
            R = 6371000.0
            lat1 = Math.degreesToRadians(float(infoB.latitude));
            lng1 = Math.degreesToRadians(float(infoB.longitude));
            bearing = Math.degreesToRadians(float(infoB.groundTrackHeading));

            lat2 = Math.radiansToDegrees(
                math.asin(math.sin(lat1) * math.cos(distance / R) +
                          math.cos(lat1) * math.sin(distance / R) * math.cos(bearing))
            )

            lng2 = Math.radiansToDegrees(
                lng1 + math.atan2(math.sin(bearing) * math.sin(distance / R) * math.cos(lat1),
                                  math.cos(distance / R) - math.sin(lat1) * math.sin(lat2))
            )

            alt = float(infoB.altitude) + (float(infoB.verticalVelocity) * propInterval)

            newObs = Observation()

            newObs.flight = self.flight
            newObs.latitude = lat2
            newObs.longitude = lng2
            newObs.altitude = alt
            newObs.groundTrackHeading = groundTrackHeading
            newObs.verticalVelocity = infoB.verticalVelocity
            newObs.horizontalVelocity = infoB.horizontalVelocity
            newObs.timestamp = float(infoB.timestamp) + int(propInterval * 1000)
            newObs.simulated = True
            obs.append(newObs)
            newObs.save()

        return obs[2:]


# Used to store project informations
class About(models.Model):
    
    title    = CharField(max_length=1000, blank=True, default="")
    subtitle = CharField(max_length=1000, blank=True, default="")
    info     = TextField(blank=True, default="")
    
    index = IntegerField(default=0)
    
    externURL = URLField(verbose_name="Extern link", default="", blank=True)
    
    image = ImageField(upload_to="about_images", null=True)
    
    largeImage = ImageSpecField(source="image",
                                processors=[ResizeToFill(1920, 1080)],
                                format='JPEG',
                                options={'quality': 75, 'progressive': True})
    
    mediumImage = ImageSpecField(source="image",
                                 processors=[ResizeToFill(1280, 720)],
                                 format='JPEG',
                                 options={'quality': 75, 'progressive': True})
    
    smallImage = ImageSpecField(source="image",
                                processors=[ResizeToFill(640, 360)],
                                format='JPEG',
                                options={'quality': 75, 'progressive': True})
    
    def getShortDescription(self):
        return str(self.title + " - " + self.subtitle[:50] + "...")
    
    def toHTML(self):
        return self.info.replace("<p", "<p class=\"rl-document__paragraph\"")\
            .replace("<span", "<span class=\"rl-document__title\"")
    
    def __unicode__(self):
        return self.title + " - " + self.subtitle
    
# Send notify to all app's
class Notify(models.Model):
    
    title = CharField(max_length=1000, blank=True, default="")
    subtitle = CharField(max_length=1000, blank=True, default="")
    info = TextField(blank=True, default="")

    showDate = DateTimeField()
    
    vibrate = BooleanField(default=True)
    song = BooleanField(default=False)
    
    def __unicode__(self):
        return self.title + " - " + self.subtitle


# Radar Livre Softwares
class Software(models.Model): 
    
    title = CharField(max_length=1000, blank=True, default="")
    
    versionName = CharField(max_length=1000, blank=True, default="")
    versionCode = IntegerField(default=0)
    
    lastUpdate = DateField(default=0)
    
    executable = FileField(
        upload_to="softwares/collector"
    )

